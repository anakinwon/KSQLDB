<MS-SQL 계층구조 이해하기>

-- 1. 테이블 삭제
```
DROP TABLE HTABLE ;
```

-- 2. 테이블 생성
```
CREATE TABLE HTABLE (
      DEPT_NO      int NOT  NULL  -- PRIMARY KEY
    , DEPT_NM      nvarchar (500) NOT NULL
    , UP_DEPT_NO   int NOT  NULL
    , JOIN_DT      DATETIME
    , CONSTRAINT HTABLE_PK PRIMARY KEY NONCLUSTERED (DEPT_NO)
);
```

-- 3. PRIMARY KEY  삭제
```
ALTER TABLE HTABLE DROP CONSTRAINT HTABLE_PK;
```

-- 4. PRIMARY KEY  생성
```
ALTER TABLE HTABLE ADD CONSTRAINT HTABLE_PK PRIMARY KEY NONCLUSTERED (DEPT_NO);

INSERT INTO HTABLE (DEPT_NO, DEPT_NM, UP_DEPT_NO, JOIN_DT)  VALUES (9999, '파이네트워크', 0, getdate());

INSERT INTO HTABLE (DEPT_NO, DEPT_NM, UP_DEPT_NO, JOIN_DT)  VALUES (1, '총무부', 9999, getdate());
INSERT INTO HTABLE (DEPT_NO, DEPT_NM, UP_DEPT_NO, JOIN_DT)  VALUES (2, '인사부', 9999, getdate());
INSERT INTO HTABLE (DEPT_NO, DEPT_NM, UP_DEPT_NO, JOIN_DT)  VALUES (3, '자재부', 9999, getdate());

INSERT INTO HTABLE (DEPT_NO, DEPT_NM, UP_DEPT_NO, JOIN_DT)  VALUES (4, '총무1팀', 1, getdate());
INSERT INTO HTABLE (DEPT_NO, DEPT_NM, UP_DEPT_NO, JOIN_DT)  VALUES (5, '총무2팀', 1, getdate());
INSERT INTO HTABLE (DEPT_NO, DEPT_NM, UP_DEPT_NO, JOIN_DT)  VALUES (6, '총무3팀', 1, getdate());

INSERT INTO HTABLE (DEPT_NO, DEPT_NM, UP_DEPT_NO, JOIN_DT)  VALUES (7, '인사1팀', 2, getdate());
INSERT INTO HTABLE (DEPT_NO, DEPT_NM, UP_DEPT_NO, JOIN_DT)  VALUES (8, '인사2팀', 2, getdate());
INSERT INTO HTABLE (DEPT_NO, DEPT_NM, UP_DEPT_NO, JOIN_DT)  VALUES (9, '인사3팀', 2, getdate());

INSERT INTO HTABLE (DEPT_NO, DEPT_NM, UP_DEPT_NO, JOIN_DT)  VALUES (10, '자재1팀', 3, getdate());
INSERT INTO HTABLE (DEPT_NO, DEPT_NM, UP_DEPT_NO, JOIN_DT)  VALUES (11, '자재2팀', 3, getdate());
INSERT INTO HTABLE (DEPT_NO, DEPT_NM, UP_DEPT_NO, JOIN_DT)  VALUES (12, '자재3팀', 3, getdate());

INSERT INTO HTABLE (DEPT_NO, DEPT_NM, UP_DEPT_NO, JOIN_DT)  VALUES (13, '총무1과', 4, getdate());
INSERT INTO HTABLE (DEPT_NO, DEPT_NM, UP_DEPT_NO, JOIN_DT)  VALUES (14, '총무2과', 4, getdate());
INSERT INTO HTABLE (DEPT_NO, DEPT_NM, UP_DEPT_NO, JOIN_DT)  VALUES (15, '총무3과', 4, getdate());

INSERT INTO HTABLE (DEPT_NO, DEPT_NM, UP_DEPT_NO, JOIN_DT)  VALUES (16, '인사1과', 7, getdate());
INSERT INTO HTABLE (DEPT_NO, DEPT_NM, UP_DEPT_NO, JOIN_DT)  VALUES (17, '인사2과', 7, getdate());
INSERT INTO HTABLE (DEPT_NO, DEPT_NM, UP_DEPT_NO, JOIN_DT)  VALUES (18, '인사3과', 7, getdate());

INSERT INTO HTABLE (DEPT_NO, DEPT_NM, UP_DEPT_NO, JOIN_DT)  VALUES (19, '자재1과', 10, getdate());
INSERT INTO HTABLE (DEPT_NO, DEPT_NM, UP_DEPT_NO, JOIN_DT)  VALUES (20, '자재2과', 10, getdate());
INSERT INTO HTABLE (DEPT_NO, DEPT_NM, UP_DEPT_NO, JOIN_DT)  VALUES (21, '자재3과', 10, getdate());

```

-- 5. 데이터 확인
```
SELECT * FROM HTABLE;

WITH DEPT_CTE AS
    (  SELECT DEPT_NO
            , DEPT_NM
            , UP_DEPT_NO
            , 0 AS LEVEL
            , CONVERT(VARCHAR(500), FORMAT(DEPT_NO,'00000')) AS CD_PATH
         FROM HTABLE WITH(NOLOCK)
        WHERE DEPT_NO = 9999
        UNION ALL
       SELECT DT.DEPT_NO
            , DT.DEPT_NM
            , DT.UP_DEPT_NO
            , DC.LEVEL + 1
            , CONVERT(VARCHAR(500), DC.CD_PATH + '>' +　CONVERT(VARCHAR, FORMAT(DT.DEPT_NO,'00000'))) AS CD_PATH
         FROM HTABLE DT WITH(NOLOCK) INNER JOIN DEPT_CTE DC ON DC.DEPT_NO = DT.UP_DEPT_NO
    )
SELECT DEPT_NO        as 카테고리번호
     , replicate('    ', LEVEL) + DEPT_NM AS 상품명
     , DEPT_NM        as 카테고리명
     , UP_DEPT_NO     as 상위카테고리번호
     , LEVEL          as 레벨
  FROM DEPT_CTE WITH(NOLOCK)
 ORDER BY CD_PATH
```
